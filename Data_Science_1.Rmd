---
title: "Data Science Project 1"
date: "`r Sys.Date()`"
author: 
  - "Constantine Zhang"
  - "Ha Nguyen"
  - "Kemal Ege Sural"
output: 
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(results="markup", warning = F, message = F,
                      fig.width=8, fig.height=6, fig.dim=c(8,6), fig.align='center')
options(scientific=T, digits = 3,scipen = 999)
```

```{r library, include = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(tinytex)
library(kableExtra)
library(scales)
library(patchwork)
library(broom)
library(knitr)
library(car)
```

```{r data import and cleaning na value, include = FALSE}
data_counties <- read.csv("introdata_merged_counties.csv")
data_counties %>% drop_na()
```

# Preview data set

```{r preview data}
tmp <- head(data_counties, 5)
names(tmp) <- c("County FIPS","State","County",
                "Per-Capita Income (2019)","Per-Capita Income (2020)","Per-Capita Income (2021)",
                "Associate Degrees (Count, 2016–2020)","Bachelor’s Degrees (Count, 2016–2020)",
                "Associate Degrees (%)","Bachelor’s Degrees (%)",
                "Population (Est.)","Population (Male)","Population (Female)",
                "Under 5 (Count)","Age 18+ (Count)","Age 65+ (Count)","Median Age")

kable(tmp, caption = "Table 1. First 5 rows of counties data",
      format = "html", align = "c") |>
  kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed"),
                            full_width = FALSE, position = "center") |>
  kableExtra::scroll_box(width = "100%", height = "300px")
```

# Summary data set

```{r data set summary}
summary(data_counties)
```
```{r exclude extreme value}
quantile(data_counties$bachelor_degree_numbers_2016_2020, prob =0.95)
quantile(data_counties$associate_degree_numbers_2016_2020, prob =0.95)
```
- For Bachelor degree from 2015-2019: 95% of counties are ≤ 112,684; the top ~5% are > 112,684.

- For Associate degree from 2015-2019: 95% of counties are ≤ 93,890; the top ~5% are > 93,890.

```{r Per Capita Personal Income Distribution by State (2020)}

state_income <- data_counties %>%
  group_by(state) %>%
  summarize(median_income = median(per_capita_personal_income_2020, na.rm = TRUE))

state_income <- state_income %>%
  mutate(income_group = ntile(median_income, 3))

set.seed(42)  
sample_states <- state_income %>%
  group_by(income_group) %>%
  slice_sample(n = 5) %>%
  pull(state)


data_counties_filtered <- data_counties %>%
  filter(state %in% sample_states)


ggplot(data_counties_filtered, 
       aes(x = reorder(state, per_capita_personal_income_2020, FUN = median),
           y = per_capita_personal_income_2020,
           fill = state)) +
  geom_boxplot() +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Per Capita Personal Income Distribution by States (2020)",
    
    x = "State",
    y = "Per Capita Personal Income (2020)"
  )
```

The box plot displays the distribution of Per Capita Personal Income at the county level for 15 states chosen as a balanced sample across low, medium and high state-level incomes. The sorting is done by the median income of the counties within each state, placing Georgia (GA) at the bottom and North Dakota (ND) at the top. The colored boxes represent the central 50% of county incomes, with Colorado (CO) showing the greatest range. The outliers, representing specific counties with incomes far outside the typical range for that state, such as extremely wealthy county in Colorado. 



# Normality test

**Objective**
Assess whether the distribution of per-capita personal income (2019–2021) is approximately Normal, and decide how to proceed for hypothesis testing method for the next parts

**Method**

We evaluated normality using: quantile–quantile (QQ) plots against the Normal distribution

**Plotting**


```{r qqlot income 2020}
income2020_qqplots <- qqnorm(data_counties$per_capita_personal_income_2020,
                         main = "QQ Plot of Personal Income Per Capita in 2020",
                         xlab = "Theoretical Quantiles",
                         ylab = "Sample Quantiles",
                         plot.it = TRUE,
                         datax = FALSE)
qqline(data_counties$per_capita_personal_income_2020, 
       col = 2,
       lwd = 2)

```
```{r qqlot bachelor 2020}
income2020_qqplots <- qqnorm(data_counties$bachelor_degree_numbers_2016_2020,
                         main = "QQ Plot of Personal Income Per Capita in 2020",
                         xlab = "Theoretical Quantiles",
                         ylab = "Sample Quantiles",
                         plot.it = TRUE,
                         datax = FALSE)
qqline(data_counties$bachelor_degree_numbers_2016_2020, 
       col = 2,
       lwd = 2)

```
```{r qqlot associate 2020}
income2020_qqplots <- qqnorm(data_counties$associate_degree_numbers_2016_2020,
                         main = "QQ Plot of Personal Income Per Capita in 2020",
                         xlab = "Theoretical Quantiles",
                         ylab = "Sample Quantiles",
                         plot.it = TRUE,
                         datax = FALSE)
qqline(data_counties$associate_degree_numbers_2016_2020, 
       col = 2,
       lwd = 2)

```


```{r}
ggplot(data_counties, aes(x = bachelor_degree_numbers_2016_2020, y = per_capita_personal_income_2020 )) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "Bachelor’s Degree Numbers vs. Per Capita Personal Income (2020) Scatter Plot",
    x = "Number of Bachelor's Degree 2016-2020",
    y = "Personal Income Per Capita (2020)"
  ) 

ggplot(data_counties, aes(x = associate_degree_numbers_2016_2020 , y = per_capita_personal_income_2020 )) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "Associate’s Degree Numbers vs. Per Capita Personal Income (2020) Scatter Plot",
    x = "Number of Associate's Degree 2016-2020",
    y = "Personal Income Per Capita (2020)"
  ) 

```
**Result Analysis**

Across all three years, the QQ plots display a clear right-skew with a heavy upper tail: points track the 45° line in the center but bend sharply upward in the right tail, indicating many high-income counties/outliers.

The raw income variable is non-normal. This does not invalidate parametric procedures per se (especially with large samples), but it suggests:

- potential heteroskedasticity across groups,

- inflated influence of extreme values,

# Identify the extreme value

To determine the extreme values to smoothen the distribution of income, we exclude extreme value using the IQR method to define the upper and lower bound and and flagged any value outside the bound.

```{r remove extreme value for income}
data_counties_No_Outliers <- data_counties %>%
  select(state, county_FIPS, county,
         per_capita_personal_income_2019,
         per_capita_personal_income_2020,
         per_capita_personal_income_2021) %>%
  pivot_longer(
    cols = starts_with("per_capita_personal_income_"),
    names_to = "year",
    values_to = "income"
  ) %>%
  mutate(year = as.integer(sub(".*_(\\d{4})$", "\\1", year)))

data_counties_No_Outliers <- data_counties_No_Outliers %>%
  group_by(year) %>%
  mutate(
    Q1 = quantile(income, 0.25, na.rm = TRUE),
    Q3 = quantile(income, 0.75, na.rm = TRUE),
    IQRv = Q3 - Q1,
    lo = Q1 - 1.5 * IQRv,
    hi = Q3 + 1.5 * IQRv
  ) %>%
  ungroup() %>%
  filter(income >= lo, income <= hi) %>%
  select(-Q1, -Q3, -IQRv, -lo, -hi)

data_counties_No_Outliers <- data_counties_No_Outliers %>%
  pivot_wider(
    names_from = year,
    values_from = income,
    names_prefix = "No_Outlier_per_capita_personal_income_"
  )  %>%
  drop_na()

data_counties <- data_counties %>%
  left_join(data_counties_No_Outliers, by = c("state", "county_FIPS", "county"))

```

```{r remove extreme value bachelor and associate}
Q1 = quantile(data_counties$associate_degree_numbers_2016_2020, 0.25, na.rm = TRUE)
Q3 = quantile(data_counties$associate_degree_numbers_2016_2020, 0.75, na.rm = TRUE)
IQRv = Q3 - Q1
lo = Q1 - 1.5 * IQRv
hi = Q3 + 1.5 * IQRv
data_counties$associate_degree_numbers_2016_2020_No_Outliers <- 
  ifelse(
    data_counties$associate_degree_numbers_2016_2020 >= lo & 
    data_counties$associate_degree_numbers_2016_2020 <= hi,
    data_counties$associate_degree_numbers_2016_2020,
    NA
  )


Q1 = quantile(data_counties$bachelor_degree_numbers_2016_2020, 0.25, na.rm = TRUE)
Q3 = quantile(data_counties$bachelor_degree_numbers_2016_2020, 0.75, na.rm = TRUE)
IQRv = Q3 - Q1
lo = Q1 - 1.5 * IQRv
hi = Q3 + 1.5 * IQRv
data_counties$bachelor_degree_numbers_2016_2020_No_Outliers <- 
  ifelse(
    data_counties$bachelor_degree_numbers_2016_2020 >= lo & 
    data_counties$bachelor_degree_numbers_2016_2020 <= hi,
    data_counties$bachelor_degree_numbers_2016_2020,
    NA
  )

```

```{r check how much obs we have left }
data_counties_clean <- data_counties %>%
  drop_na()
length(data_counties_clean$county_FIPS)
```


```{r plot distribution}

x_limits <- c(20000, 80000)
x_breaks <- seq(20000, 80000, by = 10000)

# 2020 histogram
p2020 <- ggplot(data_counties_No_Outliers, 
                aes(x = No_Outlier_per_capita_personal_income_2020)) +
  geom_histogram(bins = 40, fill = "#2ca02c", color = "white", alpha = 0.9) +
  scale_x_continuous(labels = comma, limits = x_limits, breaks = x_breaks) +
  labs(title = "2020", x = "Income (USD)", y = "Count") +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5))


p2020 <- p2020 +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# Combine them side by side using patchwork
p_side_by_side <- p2020 + 
  plot_annotation(
    title = "Per-Capita Personal Income Distribution (IQR Outliers Removed)",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
    )
  )

p_side_by_side
```
```{r distribution for bachelor}

p_bach <- ggplot(data_counties, 
                 aes(x = bachelor_degree_numbers_2016_2020)) +
  geom_histogram(bins = 40, fill = "#1f77b4", color = "white", alpha = 0.9) +
  labs(
    title = "Bachelor Degree Numbers (2016-2020)",
    x = "Number of Bachelor Degrees",
    y = "Count"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Display the plot
p_bach

p_bach <- ggplot(data_counties, 
                 aes(x = bachelor_degree_numbers_2016_2020_No_Outliers)) +
  geom_histogram(bins = 40, fill = "#1f77b4", color = "white", alpha = 0.9) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Bachelor Degree Numbers (2016-2020, No Outliers)",
    x = "Number of Bachelor Degrees",
    y = "Count"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Display the plot
p_bach


```


```{r distribution for bachelor}
p_bach <- ggplot(data_counties, 
                 aes(x = associate_degree_numbers_2016_2020)) +
  geom_histogram(bins = 40, fill = "#1f77b4", color = "white", alpha = 0.9) +
  scale_x_continuous(labels = comma,) +
  labs(
    title = "Associate Degree Numbers (2016-2020)",
    x = "Number of Bachelor Degrees",
    y = "Count"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Display the plot
p_bach



p_bach <- ggplot(data_counties, 
                 aes(x = associate_degree_numbers_2016_2020_No_Outliers)) +
  geom_histogram(bins = 40, fill = "#1f77b4", color = "white", alpha = 0.9) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Assocaite Degree Numbers (2016-2020, No Outliers)",
    x = "Number of Bachelor Degrees",
    y = "Count"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Display the plot
p_bach





```



```{r new qqplot 2020}
income2021_qqplots_NoOut <- qqnorm(data_counties$No_Outlier_per_capita_personal_income_2020,
                         main = "QQ Plot of Personal Income Per Capita in 2020, with no Outliers",
                         xlab = "Theoretical Quantiles",
                         ylab = "Sample Quantiles",
                         plot.it = TRUE,
                         datax = FALSE)
qqline(data_counties$No_Outlier_per_capita_personal_income_2020, 
       col = 2,
       lwd = 2)
```
```{r new qqplot associate 2020}
income2021_qqplots_NoOut <- qqnorm(data_counties$bachelor_degree_numbers_2016_2020_No_Outliers,
                         main = "QQ Plot of bachelor degree number in 2020, with no Outliers",
                         xlab = "Theoretical Quantiles",
                         ylab = "Sample Quantiles",
                         plot.it = TRUE,
                         datax = FALSE)
qqline(data_counties$bachelor_degree_numbers_2016_2020_No_Outliers, 
       col = 2,
       lwd = 2)
```
```{r new qqplot associate 2020}
income2021_qqplots_NoOut <- qqnorm(data_counties$associate_degree_numbers_2016_2020_No_Outliers,
                         main = "QQ Plot of associate degree number in 2020, with no Outliers",
                         xlab = "Theoretical Quantiles",
                         ylab = "Sample Quantiles",
                         plot.it = TRUE,
                         datax = FALSE)
qqline(data_counties$associate_degree_numbers_2016_2020_No_Outliers, 
       col = 2,
       lwd = 2)
```




For per-capita personal income in 2019–2021, the extreme values are predominantly on the high side (right tail), which is consistent with the QQ plots (heavy upper tail).

After removing IQR outliers, the histograms by year become noticeably more symmetric and centered, indicating that a small number of very high-income counties were driving the skew

These extreme values likely reflect genuine high-income counties rather than data entry errors (they are consistent across years and align with known distributional features of income).

```{r scatter plot after exclude extreme value}
ggplot(data_counties, aes(x = bachelor_degree_numbers_2016_2020_No_Outliers, y = No_Outlier_per_capita_personal_income_2020 )) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "Bachelor’s Degree Numbers vs. Per Capita Personal Income (2020) 
    Scatter Plot - Exclude extreme value",
    x = "Number of Bachelor's Degree 2016-2020",
    y = "Personal Income Per Capita (2020) with no Outliers " 
  ) 
  


ggplot(data_counties, aes(x = associate_degree_numbers_2016_2020_No_Outliers , y = No_Outlier_per_capita_personal_income_2020 )) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "Associate’s Degree Numbers vs. Per Capita Personal Income (2020) 
    Scatter Plot - Exclude extreme value",
    x = "Number of Associate's Degree 2016-2020",
    y = "Personal Income Per Capita (2020)"
  ) 
```

# Calculate the 95% CI

```{r  finding Confidence Intervals for income, degree, population}
per_capita_2019_ttest <- t.test(x=data_counties$per_capita_personal_income_2019, conf.level=0.95)
per_capita_2019_ci_95 <- per_capita_2019_ttest$conf.int

per_capita_2020_ttest <- t.test(x=data_counties$per_capita_personal_income_2020, conf.level=0.95)
per_capita_2020_ci_95 <- per_capita_2020_ttest$conf.int

per_capita_2021_ttest <- t.test(x=data_counties$per_capita_personal_income_2021, conf.level=0.95)
per_capita_2021_ci_95 <- per_capita_2021_ttest$conf.int

bachelor_ttest <- t.test(x=data_counties$bachelor_degree_percentage_2015_2019, conf.level=0.95)
bachelor_ci_95 <- bachelor_ttest$conf.int

associate_ttest <- t.test(x=data_counties$associate_degree_percentage_2016_2020, conf.level=0.95)
associate_ci_95 <- associate_ttest$conf.int

population_ttest <- t.test(x=data_counties$POPESTIMATE, conf.level=0.95)
population_ci_95 <- population_ttest$conf.int
```

```{r finding Confidence interval for age}
median_age_ttest <- t.test(x=data_counties$MEDIAN_AGE_TOT, conf.level=0.95)
median_age_ci_95 <- median_age_ttest$conf.int

z        <- qnorm(0.975)
sum_pop <- sum(data_counties$POPESTIMATE,na.rm = TRUE)
share5 <- sum(data_counties$UNDER5_TOT,na.rm = TRUE) / sum_pop
se5 <- sqrt(share5 * (1 - share5) / sum_pop)
share5_ci_95 <- c(share5 - z*se5, share5 + z*se5)
share5_ci_95_pct <- share5_ci_95 * 100

share65 <- sum(data_counties$AGE65PLUS_TOT,na.rm = TRUE) / sum_pop
se65 <- sqrt(share65 * (1 - share65) / sum_pop)
share65_ci_95 <- c(share65 - z*se65, share65 + z*se65)
share65_ci_95_pct <- share65_ci_95 * 100
```

**Per-capita income (2019–2021)**:

- ***The mean county per-capita income in 2019*** is estimated to lie between `r scales::comma(round(per_capita_2019_ci_95[1], 2))` and `r scales::comma(round(per_capita_2019_ci_95[2], 2))` (95% CI).

- ***For 2020***, the 95% CI is `r scales::comma(round(per_capita_2020_ci_95[1], 2))` to `r scales::comma(round(per_capita_2020_ci_95[2], 2))`

- ***For 2021***, it is `r scales::comma(round(per_capita_2021_ci_95[1], 2))` to `r scales::comma(round(per_capita_2021_ci_95[2], 2))`.

The limited overlap across years indicates a statistically meaningful upward shift in the average county income.

**Population (mean per county)**:

- ***The mean county population*** is between `r scales::comma(round(population_ci_95[1], 2))` and `r scales::comma(round(population_ci_95[2], 2))` (95% CI). This is a wide band that reflects substantial heterogeneity across counties (very small rural counties vs large urban ones). This reflects the average county, not the national total. 

**Education**:

- ***Bachelor’s share*** (mean across counties): `r if (exists("bachelor_ci_95")) paste0("[", round(bachelor_ci_95[1],2), ", ", round(bachelor_ci_95[2],2), "]")`.

- ***Associate share *** (mean across counties): `r if (exists("associate_ci_95")) paste0("[", round(associate_ci_95[1],2), ", ", round(associate_ci_95[2],2), "]")`.

**Population composition (person-weighted) by age**:

- ***Median age*** (mean of county medians): The mean of county median ages lies between `r round(median_age_ci_95[1], 2)` and `r round(median_age_ci_95[2], 2)` (95% CI), characterizing the average county’s age profile. As we can see here, age profile is tight and middle-aged.


- ***Age 65+ overall share***: In the pooled population, the estimated share age 65+ is `r scales::percent(share65, accuracy = 0.01)`, with a 95% CI of `r scales::percent(share65_ci_95[1], accuracy = 0.01)` to `r scales::percent(share65_ci_95[2], accuracy = 0.01)`. This is a population-weighted estimate (ratio of totals), so each person counts equally.

- ***Under 5 overall share***: The overall share under age 5 is `r scales::percent(share5, accuracy = 0.01)`, with a 95% CI of `r scales::percent(share5_ci_95[1], accuracy = 0.01)` to `r scales::percent(share5_ci_95[2], accuracy = 0.01)`.

# ANOVA test

In this section, we will conduct ANOVA test to test the null hypothesis of difference in mean of income and degree across state.

**Question: Do average per-capita personal incomes (2020) differ across states?**

***Model and sample***

We ran a one-way ANOVA with state as a categorical factor and county-level per-capita income as the outcome. This tests whether between-state differences in means are larger than within-state variation across counties.

```{r  T-test to compare mean of income}
data_counties$state <- as.factor(data_counties$state)

anova_model_Income <- aov(per_capita_personal_income_2020 ~ state, data = data_counties)
summary(anova_model_Income)


anova_model_Income_NoOut <- aov(No_Outlier_per_capita_personal_income_2020 ~ state, data = data_counties)
summary(anova_model_Income_NoOut)



state_means <- data_counties %>%
  group_by(state) %>%
  summarize(mean_income = mean(per_capita_personal_income_2020, na.rm = TRUE))

state_means_No_Outliers <- data_counties %>%
  group_by(state) %>%
  summarize(mean_income = mean(No_Outlier_per_capita_personal_income_2020, na.rm = TRUE))

ggplot(state_means, aes(x = reorder(state, mean_income), y = mean_income)) +
  geom_col(fill = "skyblue") +
  geom_hline(yintercept = mean(state_means$mean_income), color = "red", linetype = "dashed", size = 1) +
  labs(title = "Mean Income by State in 2020",
       x = "State",
       y = "Mean Income") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, size = 8)
  )


ggplot(state_means_No_Outliers, aes(x = reorder(state, mean_income), y = mean_income)) +
  geom_col(fill = "skyblue") +
  geom_hline(yintercept = mean(state_means$mean_income), color = "red", linetype = "dashed", size = 1) +
  labs(title = "Mean Income by State in 2020  with no Outliers",
       x = "State",
       y = " Bachelor degree numbers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8))
```

***Result***

This result is statistically significant at even 1% level. We reject the null that all state means are equal; there is strong evidence that average county income differs by state at 1% level.  

**Question: Do mean county bachelor’s degree shares differ across states?**

```{r}
anova_model_Bachelor <- aov(bachelor_degree_numbers_2016_2020 ~ state, data = data_counties)
summary(anova_model_Bachelor)

state_means_bachelor <- data_counties %>%
  group_by(state) %>%
  summarize(bachelor_degree_numbers = mean(bachelor_degree_numbers_2016_2020, na.rm = TRUE))

state_means_bachelor_No_Outliers <- data_counties %>%
  group_by(state) %>%
  summarize(bachelor_degree_numbers = mean(bachelor_degree_numbers_2016_2020_No_Outliers, na.rm = TRUE))


anova_model_Bachelor_NoOut <- aov(bachelor_degree_numbers_2016_2020_No_Outliers ~ state, data = data_counties)
summary(anova_model_Bachelor_NoOut)

ggplot(state_means_bachelor, aes(x = reorder(state, bachelor_degree_numbers), y = bachelor_degree_numbers)) +
  geom_col(fill = "skyblue") + 
  geom_hline(yintercept = mean(state_means_bachelor$bachelor_degree_numbers), color = "red", linetype = "dashed", size = 1) +
  labs(title = "Number of bachelor degree from 2016-2020 by State",
       x = "State",
       y = " Bachelor degree numbers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8))

ggplot(state_means_bachelor_No_Outliers, aes(x = reorder(state, bachelor_degree_numbers), y = bachelor_degree_numbers)) +
  geom_col(fill = "skyblue") +
  geom_hline(yintercept = mean(state_means_bachelor_No_Outliers$bachelor_degree_numbers, na.rm = TRUE), color = "red", linetype = "dashed", size = 1) +
  labs(title = "Number of bachelor degree from 2016-2020 by State with no Outliers",
       x = "State",
       y = " Bachelor degree numbers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8))
```

***Result***:

This result is statistically significant at even the 1% level. We reject the null that all state means are equal; there is strong evidence that average county bachelor’s attainment differs by state at the 1% level.

**Question. Do mean county associate degree shares differ across states?**

```{r}
anova_model_Associate <- aov(associate_degree_numbers_2016_2020 ~ state, data = data_counties)
summary(anova_model_Associate)

anova_model_Associate_No_Outliers <- aov(associate_degree_numbers_2016_2020_No_Outliers ~ state, data = data_counties)
summary(anova_model_Associate_No_Outliers)

#group by to get state level mean 
state_means_associate <- data_counties %>%
  group_by(state) %>%
  summarize(associate_degree_numbers = mean(associate_degree_numbers_2016_2020, na.rm = TRUE))

state_means_associate_No_Outliers <- data_counties %>%
  group_by(state) %>%
  summarize(associate_degree_numbers = mean(associate_degree_numbers_2016_2020_No_Outliers, na.rm = TRUE))

#bar chart to look at distribution of state level bachelor number 
ggplot(state_means_associate, aes(x = reorder(state, associate_degree_numbers), y = associate_degree_numbers)) +
  geom_col(fill = "skyblue") +
  geom_hline(yintercept = mean(state_means_associate$associate_degree_numbers), color = "red", linetype = "dashed", size = 1) +
  labs(title = "Number of Associate degree from 2016-2020 by State",
       x = "State",
       y = " Associate degree numbers") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8))


ggplot(state_means_associate_No_Outliers, aes(x = reorder(state, associate_degree_numbers), y = associate_degree_numbers)) +
  geom_col(fill = "skyblue") +
  geom_hline(yintercept = mean(state_means_associate_No_Outliers$associate_degree_numbers, na.rm = TRUE ), color = "red", linetype = "dashed", size = 1) +
  labs(title = "Number of Associate degree from 2016-2020 by State with no outliers",
       x = "State",
       y = " Associate degree numbers") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8))
 mean(state_means_associate_No_Outliers$associate_degree_numbers)
```
```{r}
mean(state_means_associate_No_Outliers$associate_degree_numbers, na.rm = TRUE )
```

```{r}
income2019_qqplots_NoOut <- qqnorm(data_counties$No_Outlier_per_capita_personal_income_2019,
                         main = "QQ Plot of Personal Income Per Capita in 2019, with no Outliers",
                         xlab = "Theoretical Quantiles",
                         ylab = "Sample Quantiles",
                         plot.it = TRUE,
                         datax = FALSE)
qqline(data_counties$No_Outlier_per_capita_personal_income_2019, 
       col = 2,
       lwd = 2)




income2021_qqplots_NoOut <- qqnorm(data_counties$No_Outlier_per_capita_personal_income_2021,
                         main = "QQ Plot of Personal Income Per Capita in 2021, with no Outliers",
                         xlab = "Theoretical Quantiles",
                         ylab = "Sample Quantiles",
                         plot.it = TRUE,
                         datax = FALSE)
qqline(data_counties$No_Outlier_per_capita_personal_income_2021, 
       col = 2,
       lwd = 2)

```
```{r}


data_long <- data_counties %>%
  pivot_longer(cols = c(No_Outlier_per_capita_personal_income_2019,
                        No_Outlier_per_capita_personal_income_2020,
                        No_Outlier_per_capita_personal_income_2021),
               names_to = "Year",
               values_to = "Income")


leveneTest(Income ~ Year, data = data_long)
```
```{r}
data_long$Year <- factor(data_long$Year,
                         levels = c("No_Outlier_per_capita_personal_income_2019",
                                    "No_Outlier_per_capita_personal_income_2020",
                                    "No_Outlier_per_capita_personal_income_2021"),
                         labels = c("2019", "2020", "2021"))
ggplot(data_long, aes(x = Year, y = Income)) +
  geom_boxplot(fill = "skyblue") +
  labs(title = "Income Distribution by Year",
       x = "Year",
       y = "Per Capita Personal Income") +
  theme_minimal()


```

***Result***:

This result is statistically significant at even the 1% level. We reject the null that all state means are equal; there is strong evidence that average county associate-degree attainment differs by state at the 1% level.

# Chi-squares Test

```{r  Chi-squares}

data_counties <- data_counties %>%
  mutate(income_cat = case_when(
      per_capita_personal_income_2020 < quantile(per_capita_personal_income_2020, 0.33, na.rm = TRUE) ~ "Low",
      per_capita_personal_income_2020 < quantile(per_capita_personal_income_2020, 0.67, na.rm = TRUE) ~ "Medium",
      TRUE ~ "High"),
      bachelor_cat = case_when(
      bachelor_degree_percentage_2015_2019 < quantile(bachelor_degree_percentage_2015_2019, 0.33, na.rm = TRUE) ~ "Low",
      bachelor_degree_percentage_2015_2019 < quantile(bachelor_degree_percentage_2015_2019, 0.67, na.rm = TRUE) ~ "Medium",
      TRUE ~ "High"),
      associate_cat = case_when(
      associate_degree_percentage_2016_2020 < quantile(associate_degree_percentage_2016_2020, 0.33, na.rm = TRUE) ~ "Low",
      associate_degree_percentage_2016_2020 < quantile(associate_degree_percentage_2016_2020, 0.67, na.rm = TRUE) ~ "Medium",
      TRUE ~ "High"))

data_counties$income_cat <- factor(data_counties$income_cat, 
  levels = c("Low", "Medium", "High"))

data_counties$bachelor_cat <- factor(data_counties$bachelor_cat, 
  levels = c("Low", "Medium", "High"))

data_counties$associate_cat <- factor(data_counties$associate_cat, 
  levels = c("Low", "Medium", "High"))


```


### Personal Income vs. Bachelor degree 
```{r}
# Chi-square test: 
chisq_income_bachelor <- chisq.test(table(data_counties$income_cat, data_counties$bachelor_cat))
chisq_income_bachelor

ggplot(data_counties, aes(x = income_cat, fill = bachelor_cat)) +
  geom_bar(position = "fill") +
  theme_minimal() +
  labs(title = "Bachelor's Degree Distribution by Income Category",
       x = "Income Category (2020)",
       y = "Proportion of Counties",
       fill = "Bachelor's Degree (%)") +
  scale_y_continuous(labels = scales::percent)
```


### Personal Income vs. Associate degree 
```{r}
chisq_income_associate <- chisq.test(table(data_counties$income_cat, data_counties$associate_cat))
chisq_income_associate

# Visualize income vs. associate's degree relationship
ggplot(data_counties, aes(x = income_cat, fill = associate_cat)) +
  geom_bar(position = "fill") +
  theme_minimal() +
  labs(title = "Associate's Degree Distribution by Income Category",
       x = "Income Category (2020)",
       y = "Proportion of Counties",
       fill = "Associate's Degree (%)") +
  scale_y_continuous(labels = scales::percent)
```

The χ2 tests verify that there is a strong correlation between a county's educational profile and economic health (p<0.001 for both). There is a statistically proven correlation between income and both the bachelor's and associate's degree categories.

The most important factor is the bachelor's degree, which has a stronger correlation with income (χ2≈1246) than an associate's degree (χ2≈151), by more than eight times. A bachelor's degree is the main prerequisite that structurally distinguishes high-income counties from all others, even though an associate's degree is helpful.

```{r Density Distribution of Per Capita Personal Income (2020)}
ggplot(data_counties, aes(x = per_capita_personal_income_2020)) +
  geom_density(fill = "blue", alpha = 0.6, color = "darkblue") +
  geom_vline(aes(xintercept = mean(per_capita_personal_income_2020, na.rm = T)), 
             color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  labs(
    title = "Density Distribution of Per Capita Personal Income (2020)",
    subtitle = "The dashed red line indicates the mean.",
    x = "Per Capita Personal Income (2020)",
    y = "Density"
  )
```


```{r Density Distribution of Bachelors Degree Percentage}
ggplot(data_counties, aes(x = bachelor_degree_percentage_2015_2019)) +
  geom_density(fill = "green", alpha = 0.6, color = "darkgreen") +
  geom_vline(aes(xintercept = mean(bachelor_degree_percentage_2015_2019, na.rm = T)), 
             color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  labs(
    title = "Density Distribution of Bachelor's Degree Percentage (2015-2019)",
    subtitle = "The dashed red line indicates the mean.",
    x = "Percentage of Population with a Bachelor's Degree",
    y = "Density"
  )
```

The majority of the counties are concentrated at low income levels, and income is heavily skewed to the right. This occurs because the mean income in a small number of extremely wealthy counties is much higher than the mode. A similar pattern can be seen in the bachelor's degree percentage, which sharply peaks at 20%, indicating that fewer counties have extremely high educational levels. 




