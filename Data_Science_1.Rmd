---
title: "Data Science Project 1"
date: "`r Sys.Date()`"
author: 
  - "Constantine Zhang"
  - "Ha Nguyen"
  - "Kemal Ege Sural"
output: 
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(results="markup", warning = F, message = F,
                      fig.width=8, fig.height=6, fig.dim=c(8,6), fig.align='center')
options(scientific=T, digits = 3,scipen = 999)
```

```{r library, include = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(tinytex)
library(kableExtra)
```

```{r data import and cleaning na value, include = FALSE}
data_counties <- read.csv("introdata_merged_counties.csv")
data_counties %>% drop_na()
```

# Preview data set

```{r preview data}
tmp <- head(data_counties, 5)
names(tmp) <- c("County FIPS","State","County",
                "Per-Capita Income (2019)","Per-Capita Income (2020)","Per-Capita Income (2021)",
                "Associate Degrees (Count, 2016–2020)","Bachelor’s Degrees (Count, 2016–2020)",
                "Associate Degrees (%)","Bachelor’s Degrees (%)",
                "Population (Est.)","Population (Male)","Population (Female)",
                "Under 5 (Count)","Age 18+ (Count)","Age 65+ (Count)","Median Age")

kable(tmp, caption = "Table 1. First 5 rows of counties data",
      format = "html", align = "c") |>
  kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed"),
                            full_width = FALSE, position = "center") |>
  kableExtra::scroll_box(width = "100%", height = "300px")
```

# Summary data set

```{r data set summary}
summary(data_counties)
```

```{r Per Capita Personal Income Distribution by State (2020)}

data_counties_filtered <- data_counties %>%
  group_by(state) %>%
  mutate(median_income_state = median(per_capita_personal_income_2020, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(state %in% unique(.$state)[1:15]) 

ggplot(data_counties_filtered, aes(x = reorder(state, per_capita_personal_income_2020, FUN = median), 
                                   y = per_capita_personal_income_2020, 
                                   fill = state)) +
  geom_boxplot() +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Per Capita Personal Income Distribution by State (2020)",
    x = "State",
    y = "Per Capita Personal Income (2020)"
  )
```

The box plot for "Per Capita Personal Income Distribution by State (2020)" provides a summary assessment of county level economic differences within the sampled states. The visualization focuses on the top 15 states, which were selected to ensure the clarity and readability of the detailed comparisons. The analysis of central tendency indicates clear economic tiers: Massachusetts (MA) exhibits the highest median per capita income, placing it alongside New Jersey (NJ) and Maryland (MD) in the most affluent group. Conversely, states like Tennessee (TN) display a distribution concentrated at the lower end of the income scale. Colorado (CO) and Ohio (OH) present the widest boxes, signifying the greatest income disparity in income across their counties. Finally, the extreme high outliers observed in New York (NY) and California (CA) highlight the substantial concentration of wealth in a limited number of exceptional counties that significantly influence state averages.

```{r}
ggplot(data_counties, aes(x = bachelor_degree_numbers_2016_2020, y = per_capita_personal_income_2020 )) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "Bachelor’s Degree Numbers vs. Per Capita Personal Income (2020) Scatter Plot",
    x = "Number of Bachelor's Degree 2016-2020",
    y = "Personal Income Per Capita (2020)"
  ) 

ggplot(data_counties, aes(x = associate_degree_numbers_2016_2020 , y = per_capita_personal_income_2020 )) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "Associate’s Degree Numbers vs. Per Capita Personal Income (2020) Scatter Plot",
    x = "Number of Associate's Degree 2016-2020",
    y = "Personal Income Per Capita (2020)"
  ) 

```

```{r scatter plot after exclude extreme value}
ggplot(data_counties, aes(x = bachelor_degree_numbers_2016_2020, y = per_capita_personal_income_2020 )) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "Bachelor’s Degree Numbers vs. Per Capita Personal Income (2020) 
    Scatter Plot - Exclude extreme value",
    x = "Number of Bachelor's Degree 2016-2020",
    y = "Personal Income Per Capita (2020)" 
  ) + 
  scale_x_continuous(limits = c(0, 150000))  + 
  scale_y_continuous(limits = c(0, 100000))


ggplot(data_counties, aes(x = associate_degree_numbers_2016_2020 , y = per_capita_personal_income_2020 )) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "Associate’s Degree Numbers vs. Per Capita Personal Income (2020) 
    Scatter Plot - Exclude extreme value",
    x = "Number of Associate's Degree 2016-2020",
    y = "Personal Income Per Capita (2020)"
  ) +
  scale_x_continuous(limits = c(0, 150000))  +
  scale_y_continuous(limits = c(0, 100000))

```

# Identify the extreme value

To determine the extreme values, we exclude value that is more than 5 standard deviation away.
```{r exclude extreme value}
quantile(data_counties$bachelor_degree_numbers_2016_2020, prob =0.95)
quantile(data_counties$associate_degree_numbers_2016_2020, prob =0.95)

```
- For Bachelor degree from 2015-2019: 95% of counties are ≤ 112,684; the top ~5% are > 112,684.

- For Associate degree from 2015-2019: 95% of counties are ≤ 93,890; the top ~5% are > 93,890.

# Calculate the 95% CI

```{r  finding Confidence Intervals for income, degree, population}
per_capita_2019_ttest <- t.test(x=data_counties$per_capita_personal_income_2019, conf.level=0.95)
per_capita_2019_ci_95 <- per_capita_2019_ttest$conf.int

per_capita_2020_ttest <- t.test(x=data_counties$per_capita_personal_income_2020, conf.level=0.95)
per_capita_2020_ci_95 <- per_capita_2020_ttest$conf.int

per_capita_2021_ttest <- t.test(x=data_counties$per_capita_personal_income_2021, conf.level=0.95)
per_capita_2021_ci_95 <- per_capita_2021_ttest$conf.int

bachelor_ttest <- t.test(x=data_counties$bachelor_degree_percentage_2015_2019, conf.level=0.95)
bachelor_ci_95 <- bachelor_ttest$conf.int

associate_ttest <- t.test(x=data_counties$associate_degree_percentage_2016_2020, conf.level=0.95)
associate_ci_95 <- associate_ttest$conf.int

population_ttest <- t.test(x=data_counties$POPESTIMATE, conf.level=0.95)
population_ci_95 <- population_ttest$conf.int
```

```{r finding Confidence interval for age}
median_age_ttest <- t.test(x=data_counties$MEDIAN_AGE_TOT, conf.level=0.95)
median_age_ci_95 <- median_age_ttest$conf.int

z        <- qnorm(0.975)
sum_pop <- sum(data_counties$POPESTIMATE,na.rm = TRUE)
share5 <- sum(data_counties$UNDER5_TOT,na.rm = TRUE) / sum_pop
se5 <- sqrt(share5 * (1 - share5) / sum_pop)
share5_ci_95 <- c(share5 - z*se5, share5 + z*se5)
share5_ci_95_pct <- share5_ci_95 * 100

share65 <- sum(data_counties$AGE65PLUS_TOT,na.rm = TRUE) / sum_pop
se65 <- sqrt(share65 * (1 - share65) / sum_pop)
share65_ci_95 <- c(share65 - z*se65, share65 + z*se65)
share65_ci_95_pct <- share65_ci_95 * 100
```

**Per-capita income (2019–2021)**:

- ***The mean county per-capita income in 2019*** is estimated to lie between `r scales::comma(round(per_capita_2019_ci_95[1], 2))` and `r scales::comma(round(per_capita_2019_ci_95[2], 2))` (95% CI).

- ***For 2020***, the 95% CI is `r scales::comma(round(per_capita_2020_ci_95[1], 2))` to `r scales::comma(round(per_capita_2020_ci_95[2], 2))`

- ***For 2021***, it is `r scales::comma(round(per_capita_2021_ci_95[1], 2))` to `r scales::comma(round(per_capita_2021_ci_95[2], 2))`.

The limited overlap across years indicates a statistically meaningful upward shift in the average county income.

**Population (mean per county)**:

- ***The mean county population*** is between `r scales::comma(round(population_ci_95[1], 2))` and `r scales::comma(round(population_ci_95[2], 2))` (95% CI). This is a wide band that reflects substantial heterogeneity across counties (very small rural counties vs large urban ones). This reflects the average county, not the national total. 

**Education**:

- ***Bachelor’s share*** (mean across counties): `r if (exists("bachelor_ci_95")) paste0("[", round(bachelor_ci_95[1],2), ", ", round(bachelor_ci_95[2],2), "]")`.

- ***Associate share *** (mean across counties): `r if (exists("associate_ci_95")) paste0("[", round(associate_ci_95[1],2), ", ", round(associate_ci_95[2],2), "]")`.

**Population composition (person-weighted) by age**:

- ***Median age*** (mean of county medians): The mean of county median ages lies between `r round(median_age_ci_95[1], 2)` and `r round(median_age_ci_95[2], 2)` (95% CI), characterizing the average county’s age profile. As we can see here, age profile is tight and middle-aged.


- ***Age 65+ overall share***: In the pooled population, the estimated share age 65+ is `r scales::percent(share65, accuracy = 0.01)`, with a 95% CI of `r scales::percent(share65_ci_95[1], accuracy = 0.01)` to `r scales::percent(share65_ci_95[2], accuracy = 0.01)`. This is a population-weighted estimate (ratio of totals), so each person counts equally.

- ***Under 5 overall share***: The overall share under age 5 is `r scales::percent(share5, accuracy = 0.01)`, with a 95% CI of `r scales::percent(share5_ci_95[1], accuracy = 0.01)` to `r scales::percent(share5_ci_95[2], accuracy = 0.01)`.

# ANOVA test

In this section, we will conduct ANOVA test to test the null hypothesis of difference in mean of income and degree across state.

**Question: Do average per-capita personal incomes (2020) differ across states?**

***Model and sample***

We ran a one-way ANOVA with state as a categorical factor and county-level per-capita income as the outcome. This tests whether between-state differences in means are larger than within-state variation across counties.
```{r  T-test to compare mean of income}
data_counties$state <- as.factor(data_counties$state)
anova_model_Income <- aov(per_capita_personal_income_2020 ~ state, data = data_counties)
summary(anova_model_Income)

state_means <- data_counties %>%
  group_by(state) %>%
  summarize(mean_income = mean(per_capita_personal_income_2020, na.rm = TRUE))

ggplot(state_means, aes(x = state, y = mean_income)) +
  geom_col(fill = "skyblue") +
  labs(title = "Mean Income by State in 2020",
       x = "State",
       y = "Mean Income") +
  theme_minimal()
```

***Result***

This result is statistically significant at even 1% level. We reject the null that all state means are equal; there is strong evidence that average county income differs by state at 1% level.  

**Question: Do mean county bachelor’s degree shares differ across states?**

```{r}
anova_model_Bachelor <- aov(bachelor_degree_numbers_2016_2020 ~ state, data = data_counties)
summary(anova_model_Bachelor)

state_means_bachelor <- data_counties %>%
  group_by(state) %>%
  summarize(bachelor_degree_numbers = mean(bachelor_degree_numbers_2016_2020, na.rm = TRUE))

ggplot(state_means_bachelor, aes(x = state, y = bachelor_degree_numbers )) +
  geom_col(fill = "skyblue") +
  labs(title = "Number of bachelor degree from 2016-2020 by State",
       x = "State",
       y = " Bachelor degree numbers") +
  theme_minimal()
```

***Result***:

This result is statistically significant at even the 1% level. We reject the null that all state means are equal; there is strong evidence that average county bachelor’s attainment differs by state at the 1% level.

**Question. Do mean county associate degree shares differ across states?**

```{r}
anova_model_Associate <- aov(associate_degree_numbers_2016_2020 ~ state, data = data_counties)
summary(anova_model_Associate)
#group by to get state level mean 
state_means_associate <- data_counties %>%
  group_by(state) %>%
  summarize(associate_degree_numbers = mean(associate_degree_numbers_2016_2020, na.rm = TRUE))
#bar chart to look at distribution of state level bachelor number 
ggplot(state_means_associate, aes(x = state, y = associate_degree_numbers )) +
  geom_col(fill = "skyblue") +
  labs(title = "Number of Associate degree from 2016-2020 by State",
       x = "State",
       y = " Associate degree numbers") +
  theme_minimal()
```

***Result***:

This result is statistically significant at even the 1% level. We reject the null that all state means are equal; there is strong evidence that average county associate-degree attainment differs by state at the 1% level.

# Chi-squares Test

```{r  Chi-squares}
#In this section, we will conduct annova test to test the null hypothesis of relationship between income and degree/ gender/ age across states
```


```{r Density Distribution of Per Capita Personal Income (2020)}
ggplot(data_counties, aes(x = per_capita_personal_income_2020)) +
  geom_density(fill = "blue", alpha = 0.6, color = "darkblue") +
  geom_vline(aes(xintercept = mean(per_capita_personal_income_2020, na.rm = T)), 
             color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  labs(
    title = "Density Distribution of Per Capita Personal Income (2020)",
    subtitle = "The dashed red line indicates the mean.",
    x = "Per Capita Personal Income (2020)",
    y = "Density"
  )
```


```{r Density Distribution of Bachelors Degree Percentage}
ggplot(data_counties, aes(x = bachelor_degree_percentage_2015_2019)) +
  geom_density(fill = "green", alpha = 0.6, color = "darkgreen") +
  geom_vline(aes(xintercept = mean(bachelor_degree_percentage_2015_2019, na.rm = T)), 
             color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  labs(
    title = "Density Distribution of Bachelor's Degree Percentage (2015-2019)",
    subtitle = "The dashed red line indicates the mean.",
    x = "Percentage of Population with a Bachelor's Degree",
    y = "Density"
  )
```

Income is highly skewed to the right, with most counties clustered at low income levels. This happens because a few very wealthy counties drag the mean income significantly higher than the mode. The Bachelor's degree percentage shows a similar trend, peaking sharply around 20%, meaning fewer counties have very high attainment. Although this educational skew is less extreme than the income skew, it also inflates the mean Bachelor's percentage.


